/*! book-management 31-10-2015 */
var bookApp=angular.module("bookApp",["ui.router","bookControllers"]);bookApp.run(["$rootScope","$state","$stateParams","$timeout",function(a,b,c,d){a.$state=b,a.$stateParams=c,a.getStars=function(a){for(var b=[],c=1;a>=c;c++)b.push(c);return b}}]),bookApp.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("books",{cache:!1,url:"/books",templateUrl:"/templates/book-list.html",controller:"ListController",resolve:{postPromise:["BookService",function(a){return a.getAllBooks()}]}}).state("detail",{cache:!1,url:"/books/{bookId}",templateUrl:"/templates/book-detail.html",controller:"DetailController",resolve:{book:["$stateParams","BookService",function(a,b){return b.getBook(a.bookId)}]}}).state("create",{cache:!1,url:"/create",templateUrl:"/templates/book-new.html",controller:"CreationController"}).state("statistics",{cache:!1,url:"/statistics",templateUrl:"/templates/book-statistics.html",controller:"StatisticsController",resolve:{postPromise:["BookService",function(a){return a.getAllBooks()}]}}).state("login",{url:"/login",templateUrl:"/templates/login.html",controller:"AuthController",onEnter:["$state","auth",function(a,b){b.isLoggedIn()&&a.go("books")}]}).state("register",{url:"/register",templateUrl:"/templates/register.html",controller:"AuthController",onEnter:["$state","auth",function(a,b){b.isLoggedIn()&&a.go("books")}]}),b.otherwise("books")}]);var bookControllers=angular.module("bookControllers",["bookServices"]);bookControllers.controller("NavController",["$scope","auth",function(a,b){a.isLoggedIn=b.isLoggedIn,a.currentUser=b.currentUser,a.logOut=b.logOut}]),bookControllers.controller("AuthController",["$scope","$state","auth",function(a,b,c){a.user={},a.register=function(){c.register(a.user).error(function(b){a.error=b}).then(function(){b.go("books")})},a.logIn=function(){c.logIn(a.user).error(function(b){a.error=b}).then(function(){b.go("books")})}}]),bookControllers.controller("ListController",["$scope","BookService","BookStatus","BookCategory","BookPosition",function(a,b,c,d,e){a.search={},a.categoryList=angular.copy(d.list),a.statusList=angular.copy(c.list),a.positions=e.list,a.orderField="category",a.books=b.books,a.filterCategory=function(b){a.strict=!0,a.search.$=void 0,0===b?a.search.category=void 0:a.search.category=b,angular.forEach(a.categoryList,function(a){a.selected=!1}),this.category.selected=!0},a.filterStatus=function(b){a.strict=!0,a.search.$=void 0,0===b?a.search.status=void 0:a.search.status=b,angular.forEach(a.statusList,function(a){a.selected=!1}),this.status.selected=!0},a.getBookCount=function(a,c){return b.getBookCount(a,c)},a.orderBooks=function(a,b){var c=angular.element(b.target);this.orderField===a?this.orderField="-"+a:this.orderField=a,c.hasClass("headerSortDown")?c.removeClass("headerSortDown").addClass("headerSortUp"):c.hasClass("headerSortUp")?c.removeClass("headerSortUp").addClass("headerSortDown"):(c.parent().children().removeClass("headerSortDown").removeClass("headerSortUp"),c.addClass("headerSortDown"))}}]),bookControllers.controller("DetailController",["$scope","$stateParams","BookService","BookCategory","BookPosition","book",function(a,b,c,d,e,f){a.book=f,a.book.date=new Date(a.book.date);var g=angular.copy(d.list);g.shift(),a.categories={categorySelect:a.book.category+"",list:g},a.positions={positionSelect:a.book.position+"",list:e.list},a.updateBook=function(){a.book.category=parseInt(a.categories.categorySelect),a.book.position=parseInt(a.positions.positionSelect),c.updateBook(a.book),a.$state.go("books")},a.removeBook=function(){c.removeBook(a.book._id),a.$state.go("books")}}]),bookControllers.controller("CreationController",["$scope","BookService","BookCategory","BookPosition",function(a,b,c,d){var e=angular.copy(c.list);e.shift(),a.categories={categorySelect:null,list:e},a.positions={positionSelect:null,list:d.list},a.date=new Date,a.status=1,a.addBook=function(){var c={title:a.title,author:a.author,category:parseInt(a.categories.categorySelect),isbn:a.isbn,label:a.label,press:a.press,date:a.date,position:parseInt(a.positions.positionSelect),status:parseInt(a.status),stars:parseInt(a.stars),notes:a.notes};b.createBook(c),a.$state.go("books")}}]),bookControllers.controller("StatisticsController",["$scope","BookService","BookCategory","BookStatus",function(a,b,c,d){var e=angular.copy(c.list);e.shift();var f=[],g=[];angular.forEach(e,function(a){f.push(a.label);var c={name:a.label,value:b.getBookCount("category",a.value)};g.push(c)});for(var h=(b.books,{status1:[],status2:[],status3:[],all:[],stars3:[],stars4:[],stars5:[]}),i=0;i<e.length;i++)h.status1.push(b.getCountByConditions("category",e[i].value,"status",1)),h.status2.push(b.getCountByConditions("category",e[i].value,"status",2)),h.status3.push(b.getCountByConditions("category",e[i].value,"status",3)),h.all.push(b.getBookCount("category",e[i].value)),h.stars3.push(b.getCountByConditions("category",e[i].value,"stars",3)),h.stars4.push(b.getCountByConditions("category",e[i].value,"stars",4)),h.stars5.push(b.getCountByConditions("category",e[i].value,"stars",5));a.drawFullLineChart=function(){require.config({paths:{echarts:"/libs/echarts"}}),require(["echarts","echarts/chart/bar"],function(a){var b=a.init(document.getElementById("fullLineChart"));b.setOption({title:{text:"左图右书完全统计",textStyle:{fontSize:14},x:"center"},legend:{x:"center",y:"bottom",data:["未读","正读","已读","全部","三星","四星","五星"]},tooltip:{trigger:"axis",textStyle:{fontSize:12},axisPointer:{type:"shadow"}},grid:{y:48,y2:80,x2:10,borderColor:"#eee"},color:["#33dd00","#33bb00","#339900","#99CC00","#ffcc00","#ff9900","#ff6600"],xAxis:[{type:"category",axisLine:{lineStyle:{width:0}},axisTick:{show:!1},splitLine:{lineStyle:{color:["#eee"]}},data:f}],yAxis:[{type:"value",axisLine:{lineStyle:{width:0}},splitLine:{lineStyle:{color:["#eee"]}}}],series:[{name:"未读",type:"bar",itemStyle:{normal:{barBorderRadius:2}},stack:"状态",data:h.status1},{name:"正读",type:"bar",itemStyle:{normal:{barBorderRadius:2}},stack:"状态",data:h.status2},{name:"已读",type:"bar",itemStyle:{normal:{barBorderRadius:2}},stack:"状态",data:h.status3},{name:"全部",type:"bar",itemStyle:{normal:{barBorderRadius:2}},data:h.all,markLine:{itemStyle:{normal:{lineStyle:{type:"dashed"}}},data:[[{type:"min"},{type:"max"}]]}},{name:"三星",type:"bar",itemStyle:{normal:{barBorderRadius:2}},stack:"评价",data:h.stars3},{name:"四星",type:"bar",itemStyle:{normal:{barBorderRadius:2}},stack:"评价",data:h.stars4},{name:"五星",itemStyle:{normal:{barBorderRadius:2}},type:"bar",stack:"评价",data:h.stars5}]})})},a.drawPieChart=function(a){require.config({paths:{echarts:"/libs/echarts"}}),require(["echarts","echarts/chart/pie"],function(b){var c=b.init(document.getElementById(a.container));c.setOption({title:{text:a.title,textStyle:{fontSize:14},x:"center"},tooltip:{trigger:"item",textStyle:{fontSize:12},formatter:"{a} <br/>{b} : {c} ({d}%)"},color:a.color,series:[{name:"左图右书",type:"pie",radius:["50%","80%"],center:["50%","60%"],itemStyle:{normal:{label:{show:!1},labelLine:{show:!1}},emphasis:{label:{show:!0,position:"center",textStyle:{fontSize:"12",fontWeight:"bold"}}}},data:a.data}]})})},a.drawFullLineChart();var j={container:"categoryPieChart",title:"类别",color:["#336666","#99CC00"],data:g};a.drawPieChart(j);var k={container:"statusPieChart",title:"状态",color:["#339900","#33bb00","#33dd00"],data:[{name:"已读",value:b.getBookCount("status",3)},{name:"正读",value:b.getBookCount("status",2)},{name:"未读",value:b.getBookCount("status",1)}]};a.drawPieChart(k);var l={container:"starsPieChart",title:"评价",color:["#ffcc00","#ff9900","#ff6600"],data:[{name:"三星",value:b.getBookCount("stars",3)},{name:"四星",value:b.getBookCount("stars",4)},{name:"五星",value:b.getBookCount("stars",5)}]};a.drawPieChart(l)}]);var bookServices=angular.module("bookServices",[]);bookServices.value("BookCategory",{list:[{label:"全部",value:0,selected:!0},{label:"文学",value:1},{label:"少儿",value:2},{label:"教育",value:3},{label:"管理",value:4},{label:"励志与成功",value:5},{label:"人文社科",value:6},{label:"生活",value:7},{label:"艺术",value:8},{label:"科技",value:9},{label:"计算机与互联网",value:10}]}),bookServices.value("BookStatus",{list:[{label:"全部",value:0,selected:!0},{label:"待购",value:4},{label:"已读",value:3},{label:"正读",value:2},{label:"未读",value:1}]}),bookServices.value("BookPosition",{list:[{label:"6-1",value:1},{label:"6-2",value:2},{label:"6-3",value:3},{label:"6-4",value:4},{label:"5-1",value:5},{label:"5-2",value:6},{label:"5-3",value:7},{label:"5-4",value:8},{label:"4-1",value:9},{label:"4-2",value:10},{label:"4-3",value:11},{label:"4-4",value:12},{label:"3-1",value:13},{label:"3-2",value:14},{label:"2-1",value:15},{label:"2-2",value:16},{label:"1-1",value:17},{label:"1-2",value:18}]}),bookServices.factory("auth",["$http","$window",function(a,b){var c={};return c.saveToken=function(a){b.localStorage["ztys-token"]=a},c.getToken=function(){return b.localStorage["ztys-token"]},c.isLoggedIn=function(){var a=c.getToken();if(a){var d=JSON.parse(b.atob(a.split(".")[1]));return d.exp>Date.now()/1e3}return!1},c.currentUser=function(){if(c.isLoggedIn){var a=c.getToken(),d=JSON.parse(b.atob(a.split(".")[1]));return d.username}},c.register=function(b){return a.post("/register",b).success(function(a){c.saveToken(a.token)})},c.logIn=function(b){return a.post("/login",b).success(function(a){c.saveToken(a.token)})},c.logOut=function(){b.localStorage.removeItem("ztys-token")},c}]),bookServices.factory("BookService",["$http",function(a){var b={books:[]};return b.getAllBooks=function(){return a.get("/books").success(function(a){angular.copy(a,b.books)})},b.getBook=function(b){return a.get("/books/"+b).then(function(a){return a.data})},b.createBook=function(c){return a.post("/books",c).success(function(a){b.books.push(a)})},b.updateBook=function(b){return a.put("/books/"+b._id,b).then(function(a){return a.data})},b.removeBook=function(b){return a["delete"]("/books/"+b).then(function(a){return console.log(a.data),a.data})},b.getBookCount=function(a,b){if(0===b)return this.books.length;for(var c=0,d=0;d<this.books.length;d++)this.books[d][a]===b&&(c+=1);return c},b.getCountByConditions=function(a,b,c,d){for(var e=0,f=0;f<this.books.length;f++)this.books[f][a]===b&&this.books[f][c]===d&&(e+=1);return e},b.getCount=function(b){return b?a.post("/bookcount/",b).then(function(a){return a.data}):void 0},b}]);